name: ðŸš€ Deploy Tokenization Pro

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.aws/**'
      - 'scripts/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.aws/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - production
      skip_infrastructure:
        description: 'Skip infrastructure deployment'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: tokenization

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.bun/install/cache
          frontend/node_modules
        key: ${{ runner.os }}-bun-${{ hashFiles('frontend/bun.lockb', 'frontend/package.json') }}
        restore-keys: |
          ${{ runner.os }}-bun-

    - name: Install dependencies
      working-directory: frontend
      run: bun install

    - name: Type check
      working-directory: frontend
      run: bun run type-check || echo "Type check failed but continuing..."

    - name: Build frontend
      working-directory: frontend
      run: bun run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 1

  # Job 2: Deploy to AWS
  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name != 'pull_request'
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    
    outputs:
      frontend-url: ${{ steps.deploy.outputs.frontend-url }}
      s3-bucket: ${{ steps.deploy.outputs.s3-bucket }}
      cloudfront-id: ${{ steps.deploy.outputs.cloudfront-id }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set environment variables
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          echo "ENVIRONMENT=production" >> $GITHUB_ENV
        else
          echo "ENVIRONMENT=development" >> $GITHUB_ENV
        fi

    - name: Deploy Infrastructure and Frontend
      id: deploy
      run: |
        chmod +x ./scripts/deploy.sh
        
        # Determine deployment flags
        DEPLOY_FLAGS=""
        if [ "${{ github.event.inputs.skip_infrastructure }}" = "true" ] || [ "${{ github.event_name }}" = "push" ]; then
          # For regular pushes, skip infrastructure to speed up deployment
          DEPLOY_FLAGS="--skip-infrastructure"
        fi
        
        # Run deployment
        echo "ðŸš€ Starting deployment with flags: $DEPLOY_FLAGS"
        ./scripts/deploy.sh $DEPLOY_FLAGS
        
        # Capture outputs
        FRONTEND_URL=$(aws cloudformation describe-stacks \
          --stack-name tokenization-infrastructure \
          --region ${{ env.AWS_REGION }} \
          --query 'Stacks[0].Outputs[?OutputKey==`FrontendURL`].OutputValue' \
          --output text)
        
        S3_BUCKET=$(aws cloudformation describe-stacks \
          --stack-name tokenization-infrastructure \
          --region ${{ env.AWS_REGION }} \
          --query 'Stacks[0].Outputs[?OutputKey==`S3BucketName`].OutputValue' \
          --output text)
          
        CLOUDFRONT_ID=$(aws cloudformation describe-stacks \
          --stack-name tokenization-infrastructure \
          --region ${{ env.AWS_REGION }} \
          --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
          --output text)
        
        echo "frontend-url=$FRONTEND_URL" >> $GITHUB_OUTPUT
        echo "s3-bucket=$S3_BUCKET" >> $GITHUB_OUTPUT
        echo "cloudfront-id=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT

    - name: Wait for CloudFront invalidation
      if: steps.deploy.outputs.cloudfront-id != ''
      run: |
        echo "â³ Waiting for CloudFront cache invalidation..."
        aws cloudfront wait invalidation-completed \
          --distribution-id ${{ steps.deploy.outputs.cloudfront-id }} \
          --id $(aws cloudfront list-invalidations \
            --distribution-id ${{ steps.deploy.outputs.cloudfront-id }} \
            --query 'InvalidationList.Items[0].Id' \
            --output text) || echo "Invalidation wait timed out, but deployment likely succeeded"

  # Job 3: Post-deployment verification
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Test frontend accessibility
      run: |
        FRONTEND_URL="${{ needs.deploy.outputs.frontend-url }}"
        if [ -n "$FRONTEND_URL" ]; then
          echo "ðŸ” Testing frontend accessibility at: $FRONTEND_URL"
          
          # Wait a bit for CloudFront to propagate
          sleep 30
          
          # Test if the site returns 200 status
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Frontend is accessible!"
          else
            echo "âš ï¸ Frontend returned status: $HTTP_STATUS"
            echo "This might be normal for a new deployment. Check manually: $FRONTEND_URL"
          fi
        else
          echo "âŒ Frontend URL not found"
          exit 1
        fi

  # Job 4: Notification
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: always() && github.event_name != 'pull_request'
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ needs.deploy.outputs.frontend-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** ${{ needs.deploy.outputs.s3-bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront ID:** ${{ needs.deploy.outputs.cloudfront-id }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the deployment logs for details." >> $GITHUB_STEP_SUMMARY
        fi